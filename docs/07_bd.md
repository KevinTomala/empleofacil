# Base de datos

## Motor y base
- Motor: MySQL 8.
- Base por defecto: `empleof_db`.
- Script de inicializacion: `init.sql`.

## Tablas principales

### Seguridad y acceso
- `usuarios`: credenciales, rol y estado (`candidato`, `empresa`, `administrador`, `superadmin`).

### Perfil del candidato
- `candidatos`: entidad principal del candidato, enlaza opcionalmente con `usuarios`.
- `candidatos_contacto`: email, telefonos y contacto de emergencia (1:1).
- `candidatos_domicilio`: direccion del candidato (1:1).
- `candidatos_salud`: tipo de sangre, estatura, peso, tatuaje (1:1).
- `candidatos_logistica`: movilidad, licencia y disponibilidad (1:1).
- `candidatos_educacion_general`: multiples registros de educacion general del candidato (1:N).
- `candidatos_idiomas`: idiomas y nivel (1:N).
- `candidatos_experiencia`: historial laboral (1:N).
- `candidatos_formaciones`: cursos/formaciones (1:N).
- `centros_capacitacion`: catalogo normalizado de instituciones/centros de capacitacion (1:N con formaciones).
- `candidatos_documentos`: documentos del candidato (1:N, con unicidad por `candidato_id + tipo_documento`).
- `candidatos_experiencia_certificados`: certificado laboral 1:1 por experiencia.

### Perfil de empresa
- `empresas`: entidad principal de companias empleadoras.
- `empresas_usuarios`: relacion N:M entre cuentas de `usuarios` y `empresas` (rol interno y usuario principal).
- `empresas_perfil`: extensiones del perfil de empresa (incluye `logo_url`, redes y completitud).
- `empresas_preferencias`: preferencias de contratacion por empresa (modalidades, niveles y observaciones).
- Completitud funcional del perfil:
  - Campos que cuentan para `%`: `nombre`, `industria`, `ubicacion_principal`, `tamano_empleados`, `descripcion`, `sitio_web`, `instagram_url`, `facebook_url`, `logo_url`.
  - `linkedin_url` se almacena, pero no bloquea completitud.

### Verificacion de cuentas
- `verificaciones_cuenta`: estado vigente de verificacion por cuenta (`empresa` o `candidato`), con nivel, revisor y vigencia.
- `verificaciones_cuenta_eventos`: historial auditable de transiciones de estado (solicitud, revision, aprobacion, rechazo, suspension, reapertura).
- Gobierno operativo:
  - `administrador` gestiona revision operativa diaria.
  - `superadmin` define excepciones, override y suspension.

### Integraciones
- `candidatos_origen`: mapeo candidato local contra origen externo (`ademy`).
- `candidatos_formaciones_origen`: mapeo formaciones locales contra formaciones externas.
- `integracion_ademy_promociones_institucion`: mapeo manual `promocion_id -> centro_cliente_id` para completar centro cliente cuando Ademy no envia nombre en acreditados.
- Diferencia funcional:
  - `candidatos_origen` opera a nivel candidato (`origen_candidato_id`).
  - `candidatos_formaciones_origen` opera a nivel formacion (`origen_formacion_id`).
  - No se repite `origen_candidato_id` en `candidatos_formaciones_origen` para evitar duplicidad.
- `integracion_sync_state`: ultima sincronizacion por origen.
- `integracion_sync_logs`: bitacora de ejecuciones de sincronizacion.

## Relaciones clave
- `candidatos.usuario_id -> usuarios.id` (ON DELETE SET NULL).
- Tablas satelite 1:1 (`contacto`, `domicilio`, `salud`, `logistica`) usan PK = `candidato_id` y FK con ON DELETE CASCADE.
- `candidatos_idiomas`, `candidatos_experiencia`, `candidatos_formaciones`, `candidatos_documentos` usan FK a `candidatos.id`.
- `candidatos_formaciones.centro_cliente_id -> centros_capacitacion.id` (`ON DELETE SET NULL`).
- `candidatos_educacion_general` usa FK a `candidatos.id`.
- `candidatos_experiencia_certificados.experiencia_id -> candidatos_experiencia.id` (UNIQUE, ON DELETE CASCADE).

## Extension Fase 2 (formacion/experiencia)
- `candidatos_formaciones` extiende campos de perfil:
  - `categoria_formacion`, `subtipo_formacion`
  - `centro_cliente_id` (opcional), `institucion`, `nombre_programa`, `titulo_obtenido`
  - `entidad_emisora`, `numero_registro`, `fecha_emision`, `fecha_vencimiento`
- Convencion integracion Ademy:
  - `candidatos_formaciones.institucion` guarda snapshot del nombre del centro/empresa cliente que contrato la capacitacion (incluyendo sucursal cuando aplique).
  - `candidatos_formaciones.centro_cliente_id` referencia el catalogo para normalizacion y autocomplete.
- `candidatos_formaciones` limpio (sin columnas legacy): no usa `matricula_id`, `nivel_id`, `curso_id`, `formacion_origen_id`, `estado`, `fecha_inicio`, `fecha_fin`.
- Fechas oficiales de formacion externa: `fecha_aprobacion`, `fecha_emision`, `fecha_vencimiento`.
- Todos los campos nuevos son `NULL`-friendly para no romper importaciones existentes.
- Separacion funcional vigente:
  - `candidatos_educacion_general`: formacion academica (tab Academica, multiple).
  - `candidatos_formaciones`: formacion externa/importada (tab Externa).
  - `candidatos_experiencia_certificados`: certificacion laboral por experiencia.

## Indices y reglas importantes
- `usuarios.email` es unico.
- `candidatos.documento_identidad` es unico.
- `candidatos_documentos` tiene unico `uk_candidato_tipo_doc`.
- Mapeos de origen tienen unicidad por origen (`uq_origen_candidato`, `uq_origen_formacion`).

## Notas operativas
- Varias tablas tienen `deleted_at` para borrado logico.
- El backend filtra candidatos activos acreditados para listado de talento.
- La sincronizacion Ademy mantiene estado en `integracion_sync_state` y detalle en `integracion_sync_logs`.

## Estrategia de archivos (Cloudflare R2 con 2 buckets)
- Se define un esquema de doble bucket:
  - Bucket `ademy` (origen academico existente).
  - Bucket `empleofacil` (archivos nuevos o copias controladas).
- Para documentos provenientes de Ademy, EmpleoFacil debe guardar punteros en BD y no duplicar archivo fisico por defecto.
- Campos minimos del puntero (en la tabla de documentos que aplique):
  - `origen` (`ademy` | `empleofacil`).
  - `bucket` (nombre del bucket R2).
  - `object_key` (ruta/clave interna del objeto).
  - Metadatos: `tipo_mime`, `tamanio_kb` (o bytes), `nombre_original`, `hash_sha256` (si existe), `updated_at_origen` (opcional).
- Mientras se mantenga solo referencia (`origen=ademy`), no se duplica costo de almacenamiento.
- La copia fisica a bucket propio (`ademy -> empleofacil`) debe ser excepcional, por politica:
  - Requisito legal/auditoria.
  - Necesidad de independencia operativa.
  - Cambio de archivo dentro de EmpleoFacil (copy-on-write).

### Regla de propiedad al actualizar documentos
- Documento heredado de Ademy inicia como referencia (`origen=ademy`) y gestion externa.
- Si el usuario actualiza/reemplaza ese documento desde EmpleoFacil:
  - El nuevo archivo se guarda en bucket `empleofacil`.
  - El registro activo pasa a `origen=empleofacil`.
  - El documento de Ademy queda como historial/referencia (no se sobrescribe).
- Resultado operativo:
  - En Ademy la gestion sigue centralizada (secretaria).
  - En EmpleoFacil la responsabilidad del dato actualizado es del usuario final.
