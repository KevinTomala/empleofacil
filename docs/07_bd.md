# Base de datos

## Motor y base
- Motor: MySQL 8.
- Base por defecto: `empleof_db`.
- Script de inicializacion: `init.sql`.

## Tablas principales

### Seguridad y acceso
- `usuarios`: credenciales, rol y estado (`candidato`, `empresa`, `administrador`, `superadmin`).

### Perfil del candidato
- `candidatos`: entidad principal del candidato, enlaza opcionalmente con `usuarios`.
- `candidatos_contacto`: email, telefonos y contacto de emergencia (1:1).
- `candidatos_domicilio`: direccion del candidato (1:1).
- `candidatos_salud`: tipo de sangre, estatura, peso, tatuaje (1:1).
- `candidatos_logistica`: movilidad, licencia y disponibilidad (1:1).
- `candidatos_educacion_general`: nivel e institucion (1:1).
- `candidatos_idiomas`: idiomas y nivel (1:N).
- `candidatos_experiencia`: historial laboral (1:N).
- `candidatos_formaciones`: cursos/formaciones (1:N).
- `candidatos_documentos`: documentos del candidato (1:N, con unicidad por `candidato_id + tipo_documento`).

### Perfil de empresa
- `empresas`: entidad principal de companias empleadoras.
- `empresas_usuarios`: relacion N:M entre cuentas de `usuarios` y `empresas` (rol interno y usuario principal).
- `empresas_perfil`: extensiones del perfil de empresa (incluye `logo_url`, redes y completitud).
- Completitud funcional del perfil:
  - Campos que cuentan para `%`: `nombre`, `industria`, `ubicacion_principal`, `tamano_empleados`, `descripcion`, `sitio_web`, `instagram_url`, `facebook_url`, `logo_url`.
  - `linkedin_url` se almacena, pero no bloquea completitud.

### Verificacion de cuentas
- `verificaciones_cuenta`: estado vigente de verificacion por cuenta (`empresa` o `candidato`), con nivel, revisor y vigencia.
- `verificaciones_cuenta_eventos`: historial auditable de transiciones de estado (solicitud, revision, aprobacion, rechazo, suspension, reapertura).
- Gobierno operativo:
  - `administrador` gestiona revision operativa diaria.
  - `superadmin` define excepciones, override y suspension.

### Integraciones
- `candidatos_origen`: mapeo candidato local contra origen externo (`ademy`).
- `candidatos_formaciones_origen`: mapeo formaciones locales contra formaciones externas.
- `integracion_sync_state`: ultima sincronizacion por origen.
- `integracion_sync_logs`: bitacora de ejecuciones de sincronizacion.

## Relaciones clave
- `candidatos.usuario_id -> usuarios.id` (ON DELETE SET NULL).
- Tablas satelite de candidato (`contacto`, `domicilio`, `salud`, `logistica`, `educacion`) usan PK = `candidato_id` y FK con ON DELETE CASCADE.
- `candidatos_idiomas`, `candidatos_experiencia`, `candidatos_formaciones`, `candidatos_documentos` usan FK a `candidatos.id`.

## Indices y reglas importantes
- `usuarios.email` es unico.
- `candidatos.documento_identidad` es unico.
- `candidatos_documentos` tiene unico `uk_candidato_tipo_doc`.
- Mapeos de origen tienen unicidad por origen (`uq_origen_candidato`, `uq_origen_formacion`).

## Notas operativas
- Varias tablas tienen `deleted_at` para borrado logico.
- El backend filtra candidatos activos acreditados para listado de talento.
- La sincronizacion Ademy mantiene estado en `integracion_sync_state` y detalle en `integracion_sync_logs`.

## Estrategia de archivos (Cloudflare R2 con 2 buckets)
- Se define un esquema de doble bucket:
  - Bucket `ademy` (origen academico existente).
  - Bucket `empleofacil` (archivos nuevos o copias controladas).
- Para documentos provenientes de Ademy, EmpleoFacil debe guardar punteros en BD y no duplicar archivo fisico por defecto.
- Campos minimos del puntero (en la tabla de documentos que aplique):
  - `origen` (`ademy` | `empleofacil`).
  - `bucket` (nombre del bucket R2).
  - `object_key` (ruta/clave interna del objeto).
  - Metadatos: `tipo_mime`, `tamanio_kb` (o bytes), `nombre_original`, `hash_sha256` (si existe), `updated_at_origen` (opcional).
- Mientras se mantenga solo referencia (`origen=ademy`), no se duplica costo de almacenamiento.
- La copia fisica a bucket propio (`ademy -> empleofacil`) debe ser excepcional, por politica:
  - Requisito legal/auditoria.
  - Necesidad de independencia operativa.
  - Cambio de archivo dentro de EmpleoFacil (copy-on-write).

### Regla de propiedad al actualizar documentos
- Documento heredado de Ademy inicia como referencia (`origen=ademy`) y gestion externa.
- Si el usuario actualiza/reemplaza ese documento desde EmpleoFacil:
  - El nuevo archivo se guarda en bucket `empleofacil`.
  - El registro activo pasa a `origen=empleofacil`.
  - El documento de Ademy queda como historial/referencia (no se sobrescribe).
- Resultado operativo:
  - En Ademy la gestion sigue centralizada (secretaria).
  - En EmpleoFacil la responsabilidad del dato actualizado es del usuario final.
